---
import galleryScript from '../lib/gallery.ts?url';

// Fetch gallery images at build time
async function fetchGalleryImages() {
  try {
    const apiKey = import.meta.env.PUBLIC_DRIVE_API_KEY;
    const folderId = import.meta.env.PUBLIC_GALLERY_FOLDER_ID;

    if (!apiKey || !folderId) {
      console.warn('[gallery] Missing API credentials, using fallback');
      return [];
    }

    const url = `https://www.googleapis.com/drive/v3/files?q='${folderId}'+in+parents+and+mimeType+contains+'image/'and+trashed=false&fields=files(id,name,thumbnailLink,webContentLink)&supportsAllDrives=true&key=${apiKey}`;

    const res = await fetch(url);

    if (!res.ok) {
      console.warn('[gallery] Build-time fetch failed:', res.status);
      return [];
    }

    const data = await res.json();

    const images = (data.files || []).map((file: any) => {
      const fileId = file.id;
      return {
        url: `https://drive.google.com/uc?export=view&id=${fileId}`,
        thumbnail: `https://drive.google.com/thumbnail?id=${fileId}&sz=w600`,
        alt: file.name || 'Galeriebild'
      };
    }).filter((img: { url?: string; thumbnail?: string }) => Boolean(img.url && img.thumbnail));

    console.info('[gallery] Fetched', images.length, 'images at build time');
    return images;
  } catch (error) {
    console.warn('[gallery] Build-time fetch error:', error);
    return [];
  }
}

const galleryImages = await fetchGalleryImages();
---
<section id="galerie" class="section">
  <div class="container">
    <h2>Impressionen</h2>
    <p>Highlights unserer Events in Bildern.</p>
    <div id="gallery-loading" class="card">Galerie lädt …</div>
    <div id="gallery-error" class="card is-hidden">Konnte keine Drive-Daten laden. Fallback aktiv.</div>
    <div class="carousel-container">
      <button class="carousel-nav carousel-nav-prev" aria-label="Vorheriges Bild">‹</button>
      <div id="carousel-track" class="carousel-track" aria-live="polite"></div>
      <button class="carousel-nav carousel-nav-next" aria-label="Nächstes Bild">›</button>
      <div id="carousel-dots" class="carousel-dots" role="tablist"></div>
    </div>
  </div>
  <div id="lightbox-overlay" class="lightbox-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="lightbox-content">
      <button id="lightbox-close" class="lightbox-close" aria-label="Schließen">×</button>
      <div class="lightbox-body">
        <p id="lightbox-counter" class="lightbox-counter" aria-live="polite"></p>
        <div class="lightbox-frame">
          <button id="lightbox-prev" class="lightbox-control lightbox-control-prev" aria-label="Vorheriges Bild">
            <span aria-hidden="true">‹</span>
          </button>
          <img id="lightbox-image" class="lightbox-image" alt="" />
          <button id="lightbox-next" class="lightbox-control lightbox-control-next" aria-label="Nächstes Bild">
            <span aria-hidden="true">›</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</section>
<script id="gallery-data" type="application/json" set:html={JSON.stringify(galleryImages)} />
<script type="module" src={galleryScript} defer></script>
