---
import menuScript from '../lib/fetchMenu.ts?url';
import { readFile } from 'node:fs/promises';
import path from 'node:path';
import { FALLBACK_ITEMS } from '../lib/menuParser';

// Load menu data at build time
async function loadMenuData() {
  try {
    const menuPath = path.resolve('public/menu.json');
    const content = await readFile(menuPath, 'utf-8');
    const parsed = JSON.parse(content);

    if (parsed.items && Array.isArray(parsed.items) && parsed.items.length > 0) {
      console.info('[menu] Loaded', parsed.items.length, 'items at build time');
      return parsed.items;
    }
  } catch (error) {
    console.warn('[menu] Failed to load menu.json, using fallback:', error);
  }

  return FALLBACK_ITEMS;
}

const menuItems = await loadMenuData();
---
<section id="menu" class="section menu-section" aria-live="polite">
  <div class="container">
    <a href="/" class="back-button" aria-label="Zurück zur Startseite">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
      <span>Zurück</span>
    </a>
    <header class="section-header">
      <h2>Unsere Produktauswahl</h2>
      <p class="section-lead">
        Frisch, flexibel & bereit für euer Event
      </p>
    </header>

    <div class="menu-hero__status" aria-live="polite">
      <p id="menu-loading" class="status-pill">Menü wird geladen …</p>
      <p id="menu-error" class="status-pill status-pill--error is-hidden">Fehler beim Laden der Daten. Fallback aktiv.</p>
    </div>

    <div id="menu-categories-container" class="menu-categories" aria-live="polite">
      <p class="menu-empty">Noch keine Produkte geladen.</p>
    </div>
  </div>
</section>
<script id="menu-data" type="application/json" set:html={JSON.stringify(menuItems)} />
<script type="module" src={menuScript} defer></script>
